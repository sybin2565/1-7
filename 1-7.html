<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>1-7 space 스마트 학급 서비스</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #8fd9e7 0%, #d3c3ef 100%);
      margin: 0;
      min-height: 100vh;
      color: #232323;
    }
    .hidden { display: none !important;}
    .container {
      display: flex;
      min-height: 100vh;
    }
    nav.sidebar {
      min-width: 180px;
      background: #402387;
      color: #fff;
      padding: 20px 0 0 0;
    }
    nav.sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    nav.sidebar li {
      margin-bottom: 15px;
      padding-left: 20px;
    }
    nav.sidebar a {
      color: #fff;
      text-decoration: none;
      font-size: 1.07em;
      transition: color 0.2s;
    }
    nav.sidebar a:hover { color: #39c2e6;}
    main.content {
      flex-grow: 1;
      background: #f7f7fa;
      padding: 40px 30px 30px 30px;
    }
    .page {
      display: none;
      min-height: 100vh;
    }
    .page.active {
      display: block;
    }
    .login-wrap, .console-wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(51, 62, 98, 0.1);
    }
    .login-box, .console-box {
      background: #fff;
      max-width: 380px;
      width: 100%;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(22,22,22,0.12);
      padding: 36px 32px 40px 32px;
    }
    .login-box h1, .console-box h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #442777;
    }
    .login-box input, .console-box input, .console-box select, .console-box textarea {
      width: 100%;
      padding: 11px 10px;
      margin-bottom: 14px;
      border: 1px solid #939393;
      border-radius: 5px;
      font-size: 1em;
    }
    .login-box button, .console-box button, .btn {
      width: 100%;
      background: linear-gradient(90deg,#5561ef,#3287f5 80%);
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 12px 0;
      font-size: 1em;
      margin-top: 5px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .login-box button:hover, .console-box button:hover, .btn:hover {
      background: linear-gradient(90deg,#3287f5,#5561ef 80%);
    }
    .flex-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .settings-section, .member-table, .notice-form, .board-form, .chat-input-box {
      margin-bottom: 28px;
    }
    .section {
      background: #fff;
      border-radius: 10px;
      margin-bottom: 40px;
      padding: 18px 20px 16px 22px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.06);
    }
    .section h2 { margin-top: 0; color: #402387;}
    .notice-list, .board-list, .chat-list, .photo-list {
      max-height: 370px;
      overflow-y: auto;
      margin-top: 13px;
      margin-bottom: 5px;
    }
    .notice-item, .board-item, .chat-item {
      background: #edebf7;
      margin-bottom: 11px;
      padding: 10px 14px;
      border-radius: 7px;
      position: relative;
    }
    .notice-item .meta, .board-item .meta, .chat-item .meta {
      font-size: 0.89em;
      color: #555;
      margin-bottom: 7px;
    }
    .notice-item .cont, .board-item .cont, .chat-item .msg {
      font-size: 1.02em;
      word-break: break-all;
    }
    .notice-form textarea, .board-form textarea {
      width: 100%;
      height: 65px;
      resize: vertical;
      font-size: 1em;
      border: 1px solid #adace3;
      border-radius: 5px;
      margin-bottom: 7px;
      padding: 8px;
    }
    .board-form input[type=file], .photo-form input[type=file] {
      margin-bottom: 6px;
    }
    .photo-thumb {
      max-width: 150px; 
      max-height: 100px; 
      border-radius: 9px;
      margin-right: 10px;
      margin-bottom: 6px;
      display: inline-block;
      border: 1px solid #d3c3ef;
      background: #f0f3fb;
      vertical-align: middle;
    }
    .admin-table, .member-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
      background: #fafafe;
    }
    .admin-table th, .admin-table td, .member-table th, .member-table td {
      border: 1px solid #c3c0db;
      padding: 8px 10px;
      font-size: 0.97em;
      text-align: center;
    }
    .admin-table th, .member-table th {
      background: #ede7fb;
    }
    .member-control-btns button {
      margin: 1px 3px 0 2px;
      padding: 3px 8px;
      font-size: 0.98em;
      border-radius: 3px;
      border: none;
      background: #6f75ec;
      color: #fff;
      transition: background 0.15s;
    }
    .member-control-btns button:hover {
      background: #402387;
    }
    .chat-input-box {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .chat-input-box input[type=text] { flex-grow: 1;}
    .chat-meta {
      font-size: 0.82em;
      color: #777;
    }
    .chat-controls {
      float: right;
      display: flex;
      gap: 5px;
    }
    .chat-controls button {
      font-size: 0.92em;
      padding: 2px 7px;
      border-radius: 3px;
      background: #c5def9;
      border: 1px solid #adcdf2;
      color: #313142;
      cursor: pointer;
    }
    .chat-controls button:hover {
      background: #b7b2e9;
    }
    @media (max-width: 1100px){
      .container { flex-direction: column;}
      nav.sidebar { min-width: unset; width: 100%; padding: 0;}
      main.content { padding: 13px;}
    }
    @media (max-width: 600px){
      .login-box, .console-box { padding: 17px 7px;}
      .section { padding: 12px 4px;}
      nav.sidebar { padding-top: 7px;}
    }
  </style>
</head>
<body>
  <!-- 로그인 화면 -->
  <div id="loginPage" class="page active">
    <div class="login-wrap">
      <div class="login-box">
        <h1>1-7 space <span style="font-size:0.69em">스마트 학급</span></h1>
        <input id="loginId" type="text" placeholder="아이디">
        <input id="loginPassword" type="password" placeholder="비밀번호">
        <button onclick="handleLogin()">로그인</button>
        <div style="margin-top:16px;text-align:center; font-size:0.97em;color:#888;">
          <span id="loginMsg"></span>
        </div>
      </div>
    </div>
  </div>
  <!-- 관리자 콘솔 화면 -->
  <div id="consolePage" class="page">
    <div class="console-wrap">
      <div class="console-box" style="max-width:700px;">
        <div class="flex-between">
          <h2>관리 콘솔</h2>
          <div>
            <button style="width:auto;min-width:80px;padding:8px 16px;margin-right:5px;" onclick="gotoHome()">홈으로</button>
            <button style="width:auto;min-width:80px;padding:8px 16px;" onclick="logout()">로그아웃</button>
          </div>
        </div>
        <div class="settings-section section">
          <h3 style="margin-top:0;">회원가입 권한 비밀번호 변경</h3>
          <input type="password" id="newAuthPw" placeholder="새 권한 비밀번호">
          <button onclick="changeAuthPassword()">권한 비밀번호 변경</button>
        </div>
        <div class="settings-section section">
          <h3>회원 가입</h3>
          <div style="margin-bottom:10px;">
            <label><input type="radio" name="signup-type" checked onchange="switchSignupType('single')"> 개별가입</label>
            <label style="margin-left:19px;"><input type="radio" name="signup-type" onchange="switchSignupType('multi')"> 단체가입</label>
          </div>
          <!-- 개별 가입 폼 -->
          <div id="signupSingleBox">
            <input type="text" id="singleUserId" placeholder="아이디(직접 입력)">
            <input type="password" id="singleUserPw" placeholder="초기 비밀번호">
            <select id="singleUserRole">
              <option value="학생">학생</option>
              <option value="선생님">선생님</option>
            </select>
            <input type="password" id="singleAuthPw" placeholder="회원가입 권한 비밀번호">
            <button onclick="signupSingle()">개별 가입</button>
          </div>
          <!-- 단체 가입 폼 -->
          <div id="signupMultiBox" class="hidden">
            <textarea id="multiUserIds" rows="3" placeholder="아이디 리스트(예시:\n2510713\n2510714 ...)\n한 줄에 한 명씩"></textarea>
            <input type="password" id="multiUserPw" placeholder="초기 비밀번호(모두 동일)">
            <select id="multiUserRole">
              <option value="학생">학생</option>
              <option value="선생님">선생님</option>
            </select>
            <input type="password" id="multiAuthPw" placeholder="회원가입 권한 비밀번호">
            <button onclick="signupMulti()">단체 가입</button>
          </div>
        </div>
        <div class="section">
          <h3>회원 관리</h3>
          <div style="overflow-x:auto;">
            <table class="member-table">
              <thead>
                <tr>
                  <th>아이디</th>
                  <th>직위</th>
                  <th>비밀번호</th>
                  <th>아이디 변경</th>
                  <th>비밀번호 변경</th>
                  <th>변경</th>
                </tr>
              </thead>
              <tbody id="memberTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- 홈 화면 -->
  <div id="homePage" class="page">
    <div style="background:#442777; color:#fff;padding:24px 40px 12px 34px;">
      <div style="font-size:2em; font-weight:bold; display:inline-block;">1-7 space</div>
      <div style="float:right;font-size:1em;">
        <span id="homeUserRole"></span> 
        <span id="homeUserId"></span>
        <button class="btn" style="padding:6px 13px;width:auto;font-size:0.97em;" onclick="logout()">로그아웃</button>
        <button class="btn" id="homeConsoleBtn" style="display:none;padding:6px 13px;width:auto;font-size:0.97em;margin-left:5px;" onclick="gotoConsole()">관리 콘솔</button>
      </div>
      <div style="clear:both"></div>
    </div>
    <div class="container">
      <nav class="sidebar">
        <ul>
          <li><a href="#" onclick="showSection('notice'); return false;">공지사항</a></li>
          <li><a href="#" onclick="showSection('board'); return false;">게시판</a></li>
          <li><a href="#" onclick="showSection('chat'); return false;">채팅방</a></li>
          <li><a href="#" onclick="showSection('myinfo'); return false;">내 정보</a></li>
          <li id="sidebarConsoleBtn" style="display:none;"><a href="#" onclick="gotoConsole(); return false;">관리 콘솔</a></li>
        </ul>
      </nav>
      <main class="content">
        <!-- 공지사항 -->
        <div id="noticeSection" class="section">
          <h2>공지사항</h2>
          <div class="notice-list" id="noticeList"></div>
          <div id="noticeWriteForm" class="notice-form hidden">
            <textarea id="noticeContent" placeholder="공지 내용을 입력하세요"></textarea>
            <button onclick="submitNotice()">등록</button>
            <button onclick="cancelNotice()">취소</button>
          </div>
          <button id="noticeWriteBtn" class="btn hidden" onclick="showNoticeWriteForm()">글쓰기</button>
        </div>
        <!-- 게시판 -->
        <div id="boardSection" class="section hidden">
          <h2>게시판</h2>
          <div class="board-list" id="boardList"></div>
          <div id="boardWriteForm" class="board-form hidden">
            <textarea id="boardContent" placeholder="게시글 내용"></textarea>
            <input type="file" id="boardFile" multiple>
            <button onclick="submitBoard()">등록</button>
            <button onclick="cancelBoard()">취소</button>
          </div>
          <button class="btn" onclick="showBoardWriteForm()" id="boardWriteBtn">글쓰기</button>
        </div>
        <!-- 채팅방 -->
        <div id="chatSection" class="section hidden">
          <h2>채팅방</h2>
          <div class="chat-list" id="chatList"></div>
          <div class="chat-input-box">
            <input type="text" id="chatInput" maxlength="300" placeholder="메시지를 입력 후 Enter">
            <button onclick="submitChatMsg()">전송</button>
          </div>
        </div>
        <!-- 내 정보 -->
        <div id="myinfoSection" class="section hidden">
          <h2>내 정보 관리</h2>
          <div style="margin-bottom:15px;">
            <b>현재 아이디:</b> <span id="myUserId"></span> &nbsp; 
            <b>직위:</b> <span id="myUserRole"></span>
          </div>
          <h4>아이디 변경</h4>
          <div>
            <input type="text" id="myNewId" placeholder="새 아이디">
            <button onclick="changeMyId()">변경</button>
          </div>
          <h4 style="margin-top:20px;">비밀번호 변경</h4>
          <div>
            <input type="password" id="myCurPw" placeholder="현재 비밀번호">
            <input type="password" id="myNewPw" placeholder="새 비밀번호">
            <button onclick="changeMyPw()">비밀번호 변경</button>
          </div>
          <div style="margin-top:12px; color:#aa3964" id="myinfoMsg"></div>
        </div>
      </main>
    </div>
  </div>
  <script>
  // === 저장 키, 계정 정보 ===
  const ADMIN_ID = 'bin2565';
  const ADMIN_PW = '6474';
  const STORAGE_USERS = 'class17space_users';
  const STORAGE_AUTH_PW = 'class17space_authpw';
  const STORAGE_NOTICE = 'class17space_notice';
  const STORAGE_BOARD = 'class17space_board';
  const STORAGE_CHAT = 'class17space_chat';
  let currentUser = null, currentRole = null;

  // 동기화 기능: 브로드캐스트 채널 활용 (다중 탭, 여러 기기)
  // (1) LocalStorage 변화 감지 (다른 탭/기기도 실시간 반영)
  window.addEventListener('storage', function(e) {
    if(e.key===STORAGE_USERS) { renderMemberTable&&renderMemberTable(); updateHomeHeader(); renderMyInfo&&renderMyInfo(); }
    if(e.key===STORAGE_NOTICE) { renderNotices&&renderNotices(); }
    if(e.key===STORAGE_BOARD) { renderBoards&&renderBoards(); }
    if(e.key===STORAGE_CHAT) { renderChat&&renderChat(); }
    if(e.key===STORAGE_AUTH_PW) { /* 권한 PW UI는 버튼 알림뿐 */ }
  });

  // (2) 브로드캐스트 채널 기반 실시간 동기화(특히 모바일에서 웹앱 등 두창 사용시)
  let bc = (typeof BroadcastChannel !== "undefined") ? new BroadcastChannel("class17space_sync") : null;
  if(bc){
    bc.onmessage = e => {
      let {type, key, value} = e.data||{};
      if(key===STORAGE_USERS) { renderMemberTable&&renderMemberTable(); updateHomeHeader(); renderMyInfo&&renderMyInfo(); }
      if(key===STORAGE_NOTICE) { renderNotices&&renderNotices(); }
      if(key===STORAGE_BOARD) { renderBoards&&renderBoards(); }
      if(key===STORAGE_CHAT) { renderChat&&renderChat(); }
      if(key===STORAGE_AUTH_PW) { }
    };
  }
  // 동기화 저장 래퍼
  function syncSetItem(key, value){
    localStorage.setItem(key, typeof value === "string" ? value : JSON.stringify(value));
    if(bc) bc.postMessage({type:"sync",key,value:localStorage.getItem(key)});
  }

  function showPage(pageId){
    ['loginPage','homePage','consolePage'].forEach(pid => {
      document.getElementById(pid).classList.toggle('active', pid===pageId);
    });
  }
  function showSection(sec){
    ['notice','board','chat','myinfo'].forEach(s=>{
      document.getElementById(s+"Section").classList.toggle('hidden', s!==sec);
    });
    if(sec==="notice") renderNotices();
    if(sec==="board") renderBoards();
    if(sec==="chat") renderChat();
    if(sec==="myinfo") renderMyInfo();
  }
  function isAdmin(u){ return u&&u.role==="관리자"; }
  function isTeacher(u){ return u&&u.role==="선생님";}
  function isStudent(u){ return u&&u.role==="학생";}
  function saveUsers(users){ syncSetItem(STORAGE_USERS, users);}
  function getUsers(){ return JSON.parse(localStorage.getItem(STORAGE_USERS)||'[]'); }
  function saveAuthPw(v){ syncSetItem(STORAGE_AUTH_PW, v);}
  function getAuthPw(){ return localStorage.getItem(STORAGE_AUTH_PW)||'class2024!';} // default
  function setCurUser(u){ 
    if(u){ localStorage.setItem('_cu', JSON.stringify(u)); }
    else { localStorage.removeItem('_cu'); }
    currentUser = u;
    currentRole = u ? u.role : null;
  }
  function getCurUserFromStore(){
    let u=localStorage.getItem('_cu'); if(!u) return null;
    try{ return JSON.parse(u);}catch(_){ return null;}
  }

  // ------- 페이지 초기화 -------
  (function pageInit(){
    // 최초 관리자 없으면 확보
    let users = getUsers();
    if(!users.find(u=>u.role==="관리자")) {
      users.push({id:ADMIN_ID, pw:ADMIN_PW, role:'관리자'});
      saveUsers(users);
    }
    if(!localStorage.getItem(STORAGE_AUTH_PW)) saveAuthPw('class2024!');
    setCurUser(getCurUserFromStore());
    if(currentUser) {
      showPage('homePage');
      showSection('notice');
    } else showPage('loginPage');
    updateHomeHeader();
  })();

  // ------------- 로그인/로그아웃 ---------------
  function handleLogin(){
    let id = document.getElementById('loginId').value.trim();
    let pw = document.getElementById('loginPassword').value;
    let msg = '';
    let users = getUsers();
    let found = users.find(u=>u.id===id);
    if(!found) msg = "존재하지 않는 아이디입니다.";
    else if(found.pw!==pw) msg = "비밀번호 불일치";
    else {
      setCurUser(found);
      showPage('homePage');
      updateHomeHeader();
      showSection('notice');
      document.getElementById('loginId').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginMsg').textContent = '';
      return;
    }
    document.getElementById('loginMsg').textContent = msg;
  }
  function logout(){
    setCurUser(null);
    showPage('loginPage');
    document.getElementById('loginId').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginMsg').textContent = '';
  }

  // ---------- 홈 헤더 및 권한별 버튼 ------
  function updateHomeHeader(){
    let u = currentUser||getCurUserFromStore();
    if(!u) return;
    document.getElementById('homeUserRole').textContent = u.role? `[${u.role}] ` : '';
    document.getElementById('homeUserId').textContent = u.id;
    document.getElementById('homeConsoleBtn').style.display = isAdmin(u) ? '' : 'none';
    document.getElementById('sidebarConsoleBtn').style.display = isAdmin(u) ? '' : 'none';
  }
  function gotoConsole(){
    showPage('consolePage');
    renderConsole();
  }
  function gotoHome(){
    showPage('homePage');
    updateHomeHeader();
    showSection('notice');
  }

  // =============== 관리 콘솔 ===============
  function renderConsole(){
    renderMemberTable();
  }
  function renderMemberTable(){
    let users = getUsers();
    let tbody = document.getElementById('memberTableBody');
    tbody.innerHTML = '';
    users.forEach((u, idx)=>{
      if(u.role==="관리자") return;
      let tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.id}</td>
        <td><select id="role_${idx}">
              <option value="학생"${u.role==="학생"?' selected':''}>학생</option>
              <option value="선생님"${u.role==="선생님"?' selected':''}>선생님</option>
          </select></td>
        <td>•••</td>
        <td><input type="text" id="chgId_${idx}" placeholder="새 아이디"></td>
        <td><input type="text" id="chgPw_${idx}" placeholder="새 비밀번호"></td>
        <td class="member-control-btns">
          <button onclick="updateMember(${idx})">변경</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  function updateMember(idx){
    let users = getUsers(), u=users.filter(u=>u.role!=="관리자")[idx];
    let inputs = { 
      newId: document.getElementById(`chgId_${idx}`).value.trim(),
      newPw: document.getElementById(`chgPw_${idx}`).value,
      newRole: document.getElementById(`role_${idx}`).value
    };
    let msg = "";
    if(inputs.newId && users.find(u2=>u2.id===inputs.newId && u2!==u)) {
      msg = "이미 존재하는 아이디입니다.";
    }else{
      if(inputs.newId) u.id = inputs.newId;
      if(inputs.newRole) u.role = inputs.newRole;
      if(inputs.newPw) u.pw = inputs.newPw;
      saveUsers(users);
      alert("변경 완료");
      renderMemberTable();
    }
    if(msg) alert(msg);
  }

  // ====== 회원 가입(개별/단체) ======
  function switchSignupType(type){
    document.getElementById('signupSingleBox').classList.toggle('hidden', type==='multi');
    document.getElementById('signupMultiBox').classList.toggle('hidden', type==='single');
  }
  function signupSingle(){
    let id = document.getElementById('singleUserId').value.trim();
    let pw = document.getElementById('singleUserPw').value;
    let role = document.getElementById('singleUserRole').value;
    let authpw = document.getElementById('singleAuthPw').value;
    let users = getUsers();
    if(!id||!pw||!authpw) return alert("입력값을 모두 채워주세요.");
    if(users.find(u=>u.id===id)) return alert("이미 존재하는 아이디입니다.");
    if(authpw !== getAuthPw()) return alert("권한 비밀번호가 올바르지 않습니다.");
    users.push({id,pw,role});
    saveUsers(users);
    alert("가입 완료");
    document.getElementById('singleUserId').value='';
    document.getElementById('singleUserPw').value='';
    document.getElementById('singleAuthPw').value='';
    renderMemberTable();
  }
  function signupMulti(){
    let ids = document.getElementById('multiUserIds').value.trim().split('\n').map(s=>s.trim()).filter(Boolean);
    let pw = document.getElementById('multiUserPw').value;
    let role = document.getElementById('multiUserRole').value;
    let authpw = document.getElementById('multiAuthPw').value;
    let users = getUsers();
    if(ids.length<1||!pw||!authpw) return alert("입력값을 모두 채워주세요.");
    if(authpw !== getAuthPw()) return alert("권한 비밀번호가 올바르지 않습니다.");
    let count=0, exist=0;
    for(let id of ids){
      if(users.find(u=>u.id===id)) { exist++; continue;}
      users.push({id,pw,role});
      count++;
    }
    saveUsers(users);
    alert(`총 ${count}명 가입됨. (이미 존재:${exist}명 제외)`);
    document.getElementById('multiUserIds').value = '';
    renderMemberTable();
  }
  function changeAuthPassword(){
    let v = document.getElementById('newAuthPw').value.trim();
    if(v.length<4) return alert("4자 이상으로 입력");
    saveAuthPw(v);
    document.getElementById('newAuthPw').value = '';
    alert("변경 완료");
  }

  // ========= 공지사항 ===============
  function canWriteNotice(){
    return isAdmin(currentUser) || isTeacher(currentUser);
  }
  function renderNotices(){
    let notices = JSON.parse(localStorage.getItem(STORAGE_NOTICE)||'[]');
    let list = document.getElementById("noticeList");
    list.innerHTML = '';
    notices.forEach(n=>{
      let d = document.createElement('div');
      d.className = 'notice-item';
      d.innerHTML = `<div class="meta"><b>${n.writerRole}</b> ${n.writer}</div>
        <div class="cont">${n.content.replace(/\n/g,"<br>")}</div>
        <div class="chat-meta" style="text-align:right;">${n.time}</div>`;
      list.appendChild(d);
    });
    // 글쓰기 버튼 표출 제어
    document.getElementById('noticeWriteBtn').classList.toggle('hidden',!canWriteNotice());
    document.getElementById('noticeWriteForm').classList.add('hidden');
  }
  function showNoticeWriteForm(){
    document.getElementById('noticeWriteForm').classList.remove('hidden');
    document.getElementById('noticeWriteBtn').classList.add('hidden');
  }
  function cancelNotice(){
    document.getElementById('noticeWriteForm').classList.add('hidden');
    document.getElementById('noticeWriteBtn').classList.remove('hidden');
    document.getElementById('noticeContent').value='';
  }
  function submitNotice(){
    let content = document.getElementById('noticeContent').value.trim();
    if(!content) return alert("내용 입력");
    let n = {
      writer: currentUser.id,
      writerRole: currentUser.role,
      content,
      time: new Date().toLocaleString()
    };
    let list = JSON.parse(localStorage.getItem(STORAGE_NOTICE)||'[]');
    list.unshift(n);
    syncSetItem(STORAGE_NOTICE, list);
    renderNotices();
    document.getElementById('noticeContent').value='';
    cancelNotice();
  }

  // ============ 게시판 ==============
  function renderBoards(){
    let boards = JSON.parse(localStorage.getItem(STORAGE_BOARD)||'[]');
    let list = document.getElementById("boardList");
    list.innerHTML = '';
    boards.forEach((b,idx)=>{
      let fileHtml = '';
      if(b.files&&b.files.length){
        fileHtml = b.files.map(f=>{
          if(f.type.startsWith('image/')) return `<div>
            <img src="${f.url}" class="photo-thumb">
            <br>${f.name}</div>`;
          else return `<div><a href="${f.url}" download="${f.name}">[파일] ${f.name}</a></div>`;
        }).join("");
      }
      let meta = `<div class="meta"><b>${b.writerRole}</b> ${b.writer}</div>`;
      let content = `<div class="cont">${b.content.replace(/\n/g,"<br>")}${fileHtml&&('<div>'+fileHtml+'</div>')}</div>`;
      let time = `<div class="chat-meta" style="text-align:right;">${b.time}</div>`;
      let d = document.createElement('div');
      d.className = 'board-item';
      d.innerHTML = meta+content+time;
      list.appendChild(d);
    });
    document.getElementById('boardWriteForm').classList.add('hidden');
  }
  function showBoardWriteForm(){
    document.getElementById('boardWriteForm').classList.remove('hidden');
  }
  function cancelBoard(){
    document.getElementById('boardWriteForm').classList.add('hidden');
    document.getElementById('boardContent').value='';
    document.getElementById('boardFile').value='';
  }
  function submitBoard(){
    let content = document.getElementById('boardContent').value.trim();
    if(!content) return alert("내용을 입력하세요.");
    let files = Array.from(document.getElementById('boardFile').files);
    let boards = JSON.parse(localStorage.getItem(STORAGE_BOARD)||'[]');
    let filesArr = [];
    let fileReaders = [];
    let newBoard = {
      writer: currentUser.id,
      writerRole: currentUser.role,
      content,
      time: new Date().toLocaleString(),
      files: []
    };
    if(files.length){
      let left=files.length;
      files.forEach(f=>{
        let fr = new FileReader();
        fr.onload = function(e){
          filesArr.push({ name:f.name, type:f.type, url:e.target.result });
          left--;
          if(left===0){
            newBoard.files = filesArr;
            boards.unshift(newBoard);
            syncSetItem(STORAGE_BOARD, boards);
            renderBoards();
            cancelBoard();
          }
        };
        if(f.type.startsWith('image/')) fr.readAsDataURL(f);
        else fr.readAsDataURL(f); // 파일 다운로드를 base64로
      });
    } else {
      boards.unshift(newBoard);
      syncSetItem(STORAGE_BOARD, boards);
      renderBoards();
      cancelBoard();
    }
  }

  // ========== 채팅방 ===========
  function renderChat(){
    let chats = JSON.parse(localStorage.getItem(STORAGE_CHAT)||'[]');
    let u = currentUser;
    let chatList = document.getElementById('chatList');
    chatList.innerHTML = '';
    chats.forEach((c, idx)=>{
      let d = document.createElement('div'); d.className = 'chat-item';
      let meta = `<div class="meta">${c.writerRole} ${c.writer}  ${c.time}</div>`;
      let msg = `<div class="msg">${c.msg.replace(/\n/g,"<br>")}</div>`;
      let controls = '';
      if(c.writer===u.id) {
        controls = `<span class="chat-controls">
        <button onclick="chatEdit(${idx})">수정</button>
        <button onclick="chatDel(${idx})">삭제</button></span>`;
      }
      d.innerHTML = meta+msg+controls;
      chatList.appendChild(d);
    });
    chatList.scrollTop = chatList.scrollHeight+333;
  }
  function submitChatMsg(){
    let inp = document.getElementById('chatInput');
    let val = inp.value.trim();
    if(!val) return;
    let chats = JSON.parse(localStorage.getItem(STORAGE_CHAT)||'[]');
    chats.push({
      writer: currentUser.id, writerRole: currentUser.role,
      msg: val, time: new Date().toLocaleString()
    });
    syncSetItem(STORAGE_CHAT,chats);
    inp.value='';
    renderChat();
  }
  document.getElementById('chatInput').addEventListener('keydown',function(e){
    if(e.key==="Enter") {submitChatMsg();}
  });
  function chatEdit(idx){
    let chats = JSON.parse(localStorage.getItem(STORAGE_CHAT)||'[]');
    let origin = chats[idx];
    let newMsg = prompt("수정할 내용을 입력하세요", origin.msg);
    if(newMsg!==null && newMsg.trim()){
      chats[idx].msg = newMsg.trim();
      syncSetItem(STORAGE_CHAT, chats);
      renderChat();
    }
  }
  function chatDel(idx){
    let chats = JSON.parse(localStorage.getItem(STORAGE_CHAT)||'[]');
    if(window.confirm("정말 삭제하시겠습니까?")){
      chats.splice(idx,1);
      syncSetItem(STORAGE_CHAT, chats);
      renderChat();
    }
  }

  // ========== 내 정보 =========
  function renderMyInfo(){
    let u=currentUser;
    document.getElementById('myUserId').textContent = u.id;
    document.getElementById('myUserRole').textContent = u.role;
    document.getElementById('myinfoMsg').textContent='';
  }
  function changeMyId(){
    let newId = document.getElementById('myNewId').value.trim();
    if(!newId) return document.getElementById('myinfoMsg').textContent="새 아이디 입력";
    let users = getUsers(), me = users.find(u=>u.id===currentUser.id);
    if(users.find(u=>u.id===newId)) return document.getElementById('myinfoMsg').textContent="이미 존재하는 아이디입니다.";
    me.id = newId; currentUser.id = newId;
    saveUsers(users); setCurUser(currentUser);
    document.getElementById('myinfoMsg').textContent="아이디 변경 완료";
    updateHomeHeader();
    renderMemberTable && renderMemberTable();
    document.getElementById('myUserId').textContent = newId;
  }
  function changeMyPw(){
    let cur = document.getElementById("myCurPw").value;
    let npw = document.getElementById("myNewPw").value;
    let users=getUsers(), me=users.find(u=>u.id===currentUser.id);
    if(me.pw!==cur) { document.getElementById('myinfoMsg').textContent='현재 비밀번호가 틀립니다.'; return;}
    if(!npw) { document.getElementById('myinfoMsg').textContent='새 비밀번호 입력'; return;}
    me.pw = npw; currentUser.pw=npw;
    saveUsers(users); setCurUser(currentUser);
    document.getElementById('myinfoMsg').textContent='변경 완료';
    document.getElementById("myCurPw").value='';
    document.getElementById("myNewPw").value='';
  }

  document.getElementById('loginPassword').addEventListener('keydown',function(ev){
    if(ev.key==="Enter") handleLogin();
  });
  document.getElementById('noticeContent').addEventListener('keydown',function(ev){
    if(ev.key==='Enter'&&ev.ctrlKey) submitNotice();
  });
  document.getElementById('boardContent').addEventListener('keydown',function(ev){
    if(ev.key==='Enter'&&ev.ctrlKey) submitBoard();
  });

  if(currentUser){
    showPage('homePage');
    showSection('notice');
  } else showPage('loginPage');
  </script>
</body>
</html>

